name: Deploy to Hostinger

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    env:
      # GitHub secrets are validated at runtime, not build time
      FTP_SERVER: ${{ secrets.FTP_SERVER }}
      FTP_USERNAME: ${{ secrets.FTP_USERNAME }}
      FTP_PASSWORD: ${{ secrets.FTP_PASSWORD }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Create .htaccess
        run: |
          cat > dist/.htaccess << 'EOF'
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            
            # Redirect HTTP to HTTPS
            RewriteCond %{HTTPS} off
            RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

            # Don't rewrite files or directories
            RewriteCond %{REQUEST_FILENAME} -f [OR]
            RewriteCond %{REQUEST_FILENAME} -d
            RewriteRule ^ - [L]

            # Rewrite everything else to index.html
            RewriteRule ^ index.html [L]
          </IfModule>

          <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
          </IfModule>

          <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/webp "access plus 1 year"
            ExpiresByType image/avif "access plus 1 year"
            ExpiresByType font/woff2 "access plus 1 year"
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType text/html "access plus 0 seconds"
          </IfModule>

          <IfModule mod_headers.c>
            <FilesMatch "\.(jpg|jpeg|png|webp|avif|gif|svg|ico|woff|woff2|css|js)$">
              Header set Cache-Control "public, max-age=31536000, immutable"
            </FilesMatch>
            <FilesMatch "\.html$">
              Header set Cache-Control "public, max-age=0, must-revalidate"
            </FilesMatch>
            Header set X-Content-Type-Options "nosniff"
            Header set X-Frame-Options "SAMEORIGIN"
          </IfModule>
          EOF

      - name: Create deployment marker
        run: |
          COMMIT_SHA="${{ github.sha }}"
          DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          echo "commit=$COMMIT_SHA" > dist/version.txt
          echo "date=$DATE" >> dist/version.txt
          echo "app=tic-miton" >> dist/version.txt
          echo "Detected by browser => open /version.txt after deploy" >> dist/version.txt

      - name: Normalize FTP host and quick connectivity check
        id: ftp_host
        shell: bash
        run: |
          if [ -z "$FTP_SERVER" ]; then
            echo "Error: FTP_SERVER secret not set"
            exit 1
          fi
          host="$FTP_SERVER"
          # strip protocol prefix if present and any trailing slash
          host="${host#ftp://}"
          host="${host#ftps://}"
          host="${host%/}"
          # emit normalized host for later steps without printing it to logs
          echo "host=$host" >> "$GITHUB_OUTPUT"
          # Best-effort: check if TCP/21 is reachable without leaking host in logs
          if command -v nc >/dev/null 2>&1; then
            nc -z -w 5 "$host" 21 >/dev/null 2>&1 && echo "FTP port reachable" || echo "Warning: FTP port not reachable from runner"
          else
            echo "nc not available; skipping port check"
          fi

      - name: Detect remote webroot directory
        id: detect_webroot
        shell: bash
        run: |
          if [ -z "$FTP_USERNAME" ] || [ -z "$FTP_PASSWORD" ]; then
            echo "Error: FTP credentials not set"
            exit 1
          fi
          FTP_USER="$FTP_USERNAME"
          FTP_PASS="$FTP_PASSWORD"
          set +e
          host="${{ steps.ftp_host.outputs.host }}"
          # List root
          ROOT_LIST=$(curl -s --disable-eprt --ftp-pasv --list-only --user "$FTP_USER:$FTP_PASS" "ftp://$host/" 2>/dev/null | tr -d '\r' || true)
          echo "Remote root entries: $(echo "$ROOT_LIST" | tr '\n' ' ')"
          server_dir="/public_html/"
          if echo "$ROOT_LIST" | grep -E -q "(^|\n)public_html(\n|$)"; then
            server_dir="/public_html/"
          elif echo "$ROOT_LIST" | grep -E -q "(^|\n)domains(\n|$)"; then
            # Try Hostinger addon domain path
            DOM_LIST=$(curl -s --disable-eprt --ftp-pasv --list-only --user "$FTP_USER:$FTP_PASS" "ftp://$host/domains/ticmiton.com/public_html/" 2>/dev/null | tr -d '\r' || true)
            echo "domains/ticmiton.com/public_html entries: $(echo "$DOM_LIST" | tr '\n' ' ')"
            if [ -n "$DOM_LIST" ]; then
              server_dir="/domains/ticmiton.com/public_html/"
            fi
          fi
          echo "dir=$server_dir" >> "$GITHUB_OUTPUT"

      - name: Deploy to Hostinger via FTP
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.ftp_host.outputs.host }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          local-dir: ./dist/
          server-dir: ${{ steps.detect_webroot.outputs.dir }}
          dangerous-clean-slate: true
          protocol: ftp
          port: 21
          log-level: standard

      - name: Fallback deploy to alternate Hostinger path
        if: always()
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ steps.ftp_host.outputs.host }}
          username: ${{ env.FTP_USERNAME }}
          password: ${{ env.FTP_PASSWORD }}
          local-dir: ./dist/
          # Choose the alternate directory: if primary is public_html, try domains path; else try public_html
          server-dir: ${{ steps.detect_webroot.outputs.dir == '/public_html/' && '/domains/ticmiton.com/public_html/' || '/public_html/' }}
          dangerous-clean-slate: false
          protocol: ftp
          port: 21
          log-level: minimal
